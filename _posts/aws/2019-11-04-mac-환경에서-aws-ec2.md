---
layout: post
title:  "[AWS] Mac OS에서 ec2인스턴스에 접속하기 "
date:   2019-11-04-02:28:59
author: 한만섭
categories: aws
tags: AWS  
---

* TOC
{:toc}




![image](https://user-images.githubusercontent.com/46010705/68089166-67728f80-fea9-11e9-88fb-ac1b8ba232f1.png)



Mac 환경에서 aws를 사용하는 방법에 대해서 정리해보려고 합니다. 기존에 윈도우에서 aws ec2에 접속하는 것은 `xShell`을 사용해서 했었는데, mac은 리눅스 환경이기 때문에 자체 터미널에서 ssh(secure shell)를 사용해서 할 수 있습니다.  차근차근 정리해보도록 하겠습니다. 

### 1. ec2 인스턴스 만들기 

![image](https://user-images.githubusercontent.com/46010705/68089625-2630ae80-feae-11e9-82ef-ccc20ffee068.png)

![image](https://user-images.githubusercontent.com/46010705/68089656-7b6cc000-feae-11e9-95b9-66da473f0213.png)

보안 그룹 구성은 위와같이 해주면 됩니다. 저는 백엔드와 프론트엔드를 동시에 배포해야하기 때문에 4000,8080을 열어주었습니다.  





### 2. ec2 접속하기 

mac으로 aws ec2에 접속하는 방법은 [여기](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html)에서 확인하실 수 있습니다. 저는 `mac connect aws`라는 키워드로검색을 해서 들어갔습니다.  

![image](https://user-images.githubusercontent.com/46010705/68089715-2f6e4b00-feaf-11e9-928d-c616760b1669.png)

위의 방법으로 접속할 수 있습니다. 저는 위의 방법을 그대로 따라했는데 `ssh permission denied publickey `에러가 발생했었습니다. 이유는 위의 사진을 보면 ec2-user라고 사용자 이름을 적으라고 나와있는데, 저는 ubuntu를 만들었기 때문에 user이름이 `ubuntu`였었습니다.  [인스턴스 기본 사용자 정보보기](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/UserGuide/connection-prereqs.html#connection-prereqs-get-info-about-instance )

![image](https://user-images.githubusercontent.com/46010705/68089742-8b38d400-feaf-11e9-866c-3bc678ac2572.png)



- `.pem`파일 권한 부여하기 

  ```bash
  chmod 400 Desktop/key/___.pem
  ```

- ssh를 이용한 ec2 인스턴스 접근 

  ```bash
  ssh -i Desktop/key/___.pem ubuntu@[ip]
  ```



### 3. 프로젝트 실행 



- root권한 부여하기 

  ```bash
  sudo su root
  ```

- Nodejs & npm install 

  ```bash
  sudo apt-get install nodejs
  sudo apt-get install npm 
  npm version
  ```

- 레퍼지토리 clone

  git을 설치하려고 했는데 이미 git이 설치가 되어있어서 바로 사용했습니다.  

  ```bash
  mkdir workspace
  cd workspace
  git clone [repository url]
  ```

- Yarn 설치 

  ```bash
  npm install yarn 
  npm install -g yarn 
  ```

- 프로젝트 이동 및 실행 

  ```bash
  cd [repository Name]
  yarn install 
  [start command]
  ```

  

### 4.  백그라운드 실행 



- nohup을 이용한 백그라운드 실행

  ```bash
  apt install nohup
  nohup yarn dev &
  nohub yarn start & 
  ```

- 포트 죽이기 

  ```bash
  ps -ef
  ps -efc
  kill -9 [pid]
  ```

  

### 5.  nginx로 create-react-app 배포하기 

nginx를 사용해서 배포하기 전에 우선 빌드를 해놔야 합니다.

- build

  ```bash
  $ npm run build
  ```

- install nginx

  ```bash
  $ sudo apt install nginx
  ```

기존에 만들어진 설정파일들이 영향을 까질 수 있기 때문에 지워줘야 합니다. 

```bash
$ sudo rm /etc/nginx/sites-available/default
$ sudo rm /etc/nginx/sites-enabled/default
```

기존파일을 지웠기 때문에 이제 제가 작성할 설정파일을 만들어줍니다.  

```bash
$ cd /etc/nginx/sites-available/
$ sudo touch myapp.conf
```

파일의 설정은 아래와 같이 해줍니다.  포트는 원하시는 것으로 하시면 됩니다. 

```json
server {
  listen 80;
  location / {
    root   /home/user/myapp/build;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

```

설정파일 `sites-enabled`에서도 참조할 수 있도록 아래 명령어를 작성합니다.  

```bash
$ sudo ln -s /etc/nginx/sites-available/myapp.conf /etc/nginx/sites-enabled/myapp.conf
```

그 다음에 nginx를 멈추고 다시 실행시켜줍니다. 

```bash
$ sudo systemctl stop nginx
$ sudo systemctl start nginx
```

상태를 확인하기 위해서는 아래와 같은 명령어를 실행시켜줍니다. 

```bash
sudo systemctl status nginx
```

- 실행 결과 

![image](https://user-images.githubusercontent.com/46010705/68442499-83ad5e00-0214-11ea-8465-62a5c2027d26.png)

***



### 6. GraphQL 혹은 Node서버 forest로 배포하기 

build된 프론트엔드 파일은 `Nginx` 로 배포했던 것처럼 노드 서버도 배포하는 방법이 있습니다.  

- install 

  ```bash
  npm install -g forever
  ```

- Start

  ```bash
  forest start server.js 
  ```

위와 같은 방식으로 실행한다고 나와있는데, 자꾸 Stoped되는 현상이 발생했습니다. 저는 `yarn dev` 라는 명령어를 통해서 서버를 실행시켰는데, 아래와 같이 커맨드를 사용하겠다고 작성해주면 해결되는 이슈였습니다.  

```bash
forever start -c "yarn dev" ./
```



### 발생한 이슈 

- ubuntu 인스턴스를 만들었으면 username은 `ubuntu` 였던 것.

- 카카오 API는 사용하는 URL마다 허용해줘야해서 에러 발생 

- 백엔드 배포했는데, 접속 안되는거 ec2 인바운드 허용 안해줘서 발생한 이슈 

- `nohup`로 백그라운드 실행을 했을 때 느려지는 이슈 발생 => 인스턴스 재 설정 및 `nginx` 사용 

- aws ec2 3000 포트 열어두지 않았던 것

- aws ec2 오하이오로 생성 

- firebase Auth ip허용안해준 것 

- `styled-reset`가 node 8.x version에서는 설치가 되지 않았던 이슈 

  [node10.x 설치 사이트](3.2 nginx로 create-react-app 배포하기 )

  ```bash
  curl -sL https://deb.nodesource.com/setup_10.x | sudo bash -
  apt install nodejs
  ```

